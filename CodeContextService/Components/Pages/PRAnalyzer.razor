@page "/"
@page "/pr-analyze"
@using Microsoft.AspNetCore.Authorization
@using CodeContextService.Model
@using CodeContextService.Services
@using RoslynTools.Analyzer
@using CodeContextService.Components.ViewModels
@inject IJSRuntime JS
@inject PRAnalyzerService Analyzer
@inject GitHubIntegrationService GitHub
@rendermode InteractiveServer

<HeadContent>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <script>
        window.highlight = () => Prism.highlightAll();
        window.scrollToBottom = id => {
            const el = document.getElementById(id);
            if (el) el.scrollTop = el.scrollHeight;
        };
        window.getCookieByName = name => {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? decodeURIComponent(match[2]) : null;
        };
        window.setCookie = (name, value) => {
            document.cookie = `${name}=${encodeURIComponent(value)}; path=/; max-age=${60 * 60 * 24 * 365}`;
        };
    </script>

    <script>
        window.updateStickyOffset = () => {
            const searchEl = document.querySelector('.filter-container');
            const searchH = searchEl ? searchEl.getBoundingClientRect().height : 0;
            document.documentElement.style.setProperty('--search-bar-height', `${searchH}px`);

            const fileHdr = document.querySelector('.card.expanded > .card-header');
            if (fileHdr) {
                const fileH = fileHdr.getBoundingClientRect().height;
                document.documentElement.style.setProperty('--file-header-height', `${fileH}px`);
            }
        };
        window.addEventListener('load', updateStickyOffset);
        window.addEventListener('resize', updateStickyOffset);
    </script>

    <script>
        window.scrollIfStuck = (id, wasExpandedBefore) => {
            const el = document.getElementById(id);
            if (!el || !wasExpandedBefore) return;
            const rootStyles = getComputedStyle(document.documentElement);
            const searchH = parseFloat(rootStyles.getPropertyValue('--search-bar-height')) || 0;
            const fileH = parseFloat(rootStyles.getPropertyValue('--file-header-height')) || 0;
            const totalOffset = searchH + fileH;
            const rect = el.getBoundingClientRect();
            if (rect.top <= totalOffset + 1) {
                const targetY = window.pageYOffset + rect.top - totalOffset - 1;
                window.scrollTo({ top: targetY, left: 0, behavior: 'auto' });
            }
        };
    </script>
</HeadContent>

<PageTitle>PR Code Analyzer</PageTitle>

<div class="container py-4">
    <h3>Analyze GitHub PR</h3>

    <!-- Inputs -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <input class="form-control" placeholder="Owner"
                   value="@Owner"
                   @oninput="@(e => OnFieldChanged("Owner", e.Value?.ToString()))"
                   disabled="@IsBusy" />
        </div>
        <div class="col-md-3">
            <input class="form-control" placeholder="Repository"
                   value="@Repo"
                   @oninput="@(e => OnFieldChanged("Repo", e.Value?.ToString()))"
                   disabled="@IsBusy" />
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" placeholder="PR #"
                   value="@PrNumber"
                   @oninput="OnPrNumberChanged"
                   min="1" disabled="@IsBusy" />
        </div>
        <div class="col-md-4">
            <input type="password" class="form-control" placeholder="PAT Token"
                   value="@Token"
                   @oninput="@(e => OnFieldChanged("Token", e.Value?.ToString()))"
                   disabled="@IsBusy" />
        </div>
    </div>

    <!-- Analysis Mode (row) -->
    <div class="row mb-3">
        <div class="col" style="width:15%">
            <select class="form-select"
                    @bind="SelectedMode"
                    disabled="@IsBusy"
                    style="width:100%">
                <option value="Full">Full Analysis</option>
                <option value="Minified">Minified</option>
                <option value="MinifiedExplain">Minified + Explain</option>
            </select>
        </div>
        <div class="col" style="width:15%">
            <input type="number" class="form-control"
                   value="@Depth"
                   oninput="OnDepthChanged"
                   disabled="@IsBusy"
                   placeholder="Depth"
                   min="0"
                   style="width:100%" />
        </div>
        <div class="col">
            <!-- spacer -->
        </div>
    </div>

    <!-- Actions -->
    <button class="btn btn-outline-info me-2" @onclick="TestToken" disabled="@IsBusy">Test Token</button>
    <button class="btn btn-primary me-2" @onclick="RunAnalysis" disabled="@DisableActions">Analyze PR</button>
    <button class="btn btn-secondary" @onclick="ToggleLogs">@(LogsExpanded ? "Hide Logs ▲" : "Show Logs ▼")</button>

    <!-- Token Status -->
    <div class="mt-3">
        <div class="alert alert-success" role="alert" hidden="@(!TokenOk)">✅ Token valid</div>
        <div class="alert alert-danger" role="alert" hidden="@(!TokenFail)">❌ Token invalid</div>
    </div>

    <!-- Logs -->
    <div class="mt-4">
        @if (LogsExpanded)
        {
            <h5>Logs</h5>
            <div id="logsContainer"
                 class="border rounded p-2"
                 style="max-height:@(LogsExpanded ? "300px" : "auto");overflow-y:@(LogsExpanded ? "auto" : "visible");transition:max-height 0.3s;">
                <ul class="mb-0">
                    @foreach (var line in Log)
                    {
                        <li>@line</li>
                    }
                </ul>
            </div>
        }
    </div>

    <br />

    <!-- Busy Spinner -->
    @if (IsBusy)
    {
        <div class="d-flex justify-content-center align-items-center" style="height:200px;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Analyzing…</span>
            </div>
            <div class="mt-2"><em>@(Log.Any() ? Log.Last() : "Starting analysis…")</em></div>
        </div>
    }

    <!-- Results -->
    @if (!IsBusy && FileDiffs.Any())
    {
        <h4>Analysis Results</h4>
        <div class="mb-4 filter-container">
            <input class="form-control"
                   placeholder="Filter definitions"
                   @bind="DefFilter"
                   @bind:event="oninput"
                   disabled="@IsBusy" />
        </div>

        @foreach (var file in FileDiffs
       .Where(f => f.FileName.EndsWith(".cs", StringComparison.OrdinalIgnoreCase))
       .Where(f => string.IsNullOrWhiteSpace(DefFilter)
       || (AnalysisResults.ContainsKey(f.FileName)
       && AnalysisResults[f.FileName]
       .Any(d => d.FullName.Contains(DefFilter, StringComparison.OrdinalIgnoreCase)))))
        {
            var fileKey = file.FileName!;
            var isFileExpanded = ExpandedFiles.Contains(fileKey);
            <div class="card mb-3 shadow-sm @(isFileExpanded ? "expanded" : "")">
                <div id="fileHeader-@fileKey"
                     class="card-header d-flex justify-content-between"
                     style="cursor:pointer"
                     @onclick="async () => { await ToggleFile(fileKey); }">
                    <strong>@file.FileName</strong>
                    <span>
                        <span class="badge bg-success me-1">+@file.Added</span>
                        <span class="badge bg-danger me-1">-@file.Removed</span>
                        <span class="ms-2">@((isFileExpanded) ? "▲" : "▼")</span>
                    </span>
                </div>
                @if (isFileExpanded)
                {
                    <div class="card-body">
                        @* Diff view omitted *@

                        @foreach (var def in AnalysisResults.GetValueOrDefault(file.FileName!, Array.Empty<DefinitionDisplayModel>())
                       .Where(d => string.IsNullOrWhiteSpace(DefFilter)
                       || d.FullName.Contains(DefFilter, StringComparison.OrdinalIgnoreCase)))
                        {
                            var defKey = $"{file.FileName}|{def.FullName}";
                            var isDefExpanded = ExpandedDefs.Contains(defKey);
                            <div class="card mb-2 @(isDefExpanded ? "expanded" : "")">
                                <div class="card-header"
                                     id="defHeader-@Uri.EscapeDataString(defKey)"
                                     style="cursor:pointer"
                                     @onclick="async () => { await ToggleDef(defKey); }">
                                    <b>Definition:</b> @def.FullName
                                    <span class="ms-2">@((isDefExpanded) ? "▲" : "▼")</span>
                                </div>
                                @if (isDefExpanded)
                                {
                                    <div class="card-body p-2">
                                        <pre><code class="language-csharp">@def.Code</code></pre>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    // Persisted inputs
    string? Owner;
    string? Repo;
    int PrNumber;
    int Depth = 2;
    string? Token;
    DefinitionAnalysisMode SelectedMode { get; set; } = DefinitionAnalysisMode.Minified;

    // UI state
    bool IsBusy;
    bool TokenOk;
    bool TokenFail;
    List<string> Log { get; } = new();
    bool LogsExpanded;
    bool CookiesLoaded;
    List<FileDiff> FileDiffs { get; } = new();
    Dictionary<string, DefinitionDisplayModel[]> AnalysisResults { get; } = new();
    bool DisableActions => IsBusy || !TokenOk
                           || string.IsNullOrWhiteSpace(Owner)
                           || string.IsNullOrWhiteSpace(Repo)
                           || PrNumber <= 0;

    // Filter
    string _defFilter = string.Empty;
    string DefFilter
    {
        get => _defFilter;
        set
        {
            if (_defFilter == value) return;
            _defFilter = value;
            UpdateFilterExpansion();
        }
    }

    HashSet<string> ExpandedFiles { get; } = new();
    HashSet<string> ExpandedDefs { get; } = new();

    void UpdateFilterExpansion()
    {
        if (!string.IsNullOrWhiteSpace(_defFilter))
        {
            ExpandedFiles.Clear();
            foreach (var f in FileDiffs)
            {
                if (AnalysisResults.TryGetValue(f.FileName!, out var defs)
                    && defs.Any(d => d.FullName.Contains(_defFilter, StringComparison.OrdinalIgnoreCase)))
                {
                    ExpandedFiles.Add(f.FileName!);
                }
            }
        }
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !CookiesLoaded)
        {
            Owner = await JS.InvokeAsync<string>("getCookieByName", "Owner") ?? Owner;
            Repo = await JS.InvokeAsync<string>("getCookieByName", "Repo") ?? Repo;
            Token = await JS.InvokeAsync<string>("getCookieByName", "Token") ?? Token;
            var pr = await JS.InvokeAsync<string>("getCookieByName", "PrNumber");
            if (int.TryParse(pr, out var p)) PrNumber = p;
            var modeC = await JS.InvokeAsync<string>("getCookieByName", "AnalysisMode");
            if (Enum.TryParse(modeC, true, out DefinitionAnalysisMode m)) SelectedMode = m;
            CookiesLoaded = true;
            StateHasChanged();
        }
        await JS.InvokeVoidAsync("highlight");
    }

    private async Task OnFieldChanged(string field, string? val)
    {
        val ??= string.Empty;
        switch (field)
        {
            case "Owner": Owner = val; break;
            case "Repo": Repo = val; break;
            case "Token": Token = val; break;
        }
        await JS.InvokeVoidAsync("setCookie", field, val);
    }

    private async Task OnPrNumberChanged(ChangeEventArgs e)
    {
        var s = e.Value?.ToString();
        PrNumber = int.TryParse(s, out var v) ? v : 0;
        await JS.InvokeVoidAsync("setCookie", "PrNumber", PrNumber.ToString());
    }

    private async Task TestToken()
    {
        IsBusy = true;
        TokenOk = await GitHub.ValidateTokenAsync(Token);
        TokenFail = !TokenOk;
        await JS.InvokeVoidAsync("setCookie", "Token", Token);
        IsBusy = false;
        StateHasChanged();
    }

    private async Task RunAnalysis()
    {
        IsBusy = true;
        Log.Clear();
        FileDiffs.Clear();
        AnalysisResults.Clear();
        StateHasChanged();

        var result = await Analyzer.RunAnalysis(
            Token, Owner!, Repo!, PrNumber, Depth, SelectedMode,
            async msg => { Log.Add(msg); await InvokeAsync(StateHasChanged); }
        );

        FileDiffs.AddRange(result.FileDiffs!);
        foreach (var kv in result.DefinitionMap!)
        {
            AnalysisResults[kv.Key] = kv.Value
                .Select(x => new DefinitionDisplayModel { FullName = x.FullName, Code = x.Code })
                .ToArray();
        }

        await JS.InvokeVoidAsync("setCookie", "AnalysisMode", SelectedMode.ToString());
        IsBusy = false;
        StateHasChanged();
    }

    void ToggleLogs() => LogsExpanded = !LogsExpanded;

    async Task ToggleFile(string key)
    {
        var was = ExpandedFiles.Contains(key);
        if (was) ExpandedFiles.Remove(key); else ExpandedFiles.Add(key);
        await JS.InvokeVoidAsync("updateStickyOffset");
        await JS.InvokeVoidAsync("scrollIfStuck", $"fileHeader-{key}", was);
    }

    async Task ToggleDef(string key)
    {
        var was = ExpandedDefs.Contains(key);
        if (was) ExpandedDefs.Remove(key); else ExpandedDefs.Add(key);
        await JS.InvokeVoidAsync("updateStickyOffset");
        await JS.InvokeVoidAsync("scrollIfStuck", $"defHeader-{Uri.EscapeDataString(key)}", was);
    }
}
